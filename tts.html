<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Text to Speech Generator</title>
<style>
body {
  background:#ffffff;
  color:#111;
  font-family: Arial, Helvetica, sans-serif;
  text-align:center;
  padding:40px;
}
textarea {
  width:80%;
  height:90px;
  font-size:15px;
  padding:10px;
}
button {
  padding:12px 20px;
  margin:10px;
  font-size:16px;
  cursor:pointer;
}
audio {
  width:80%;
  margin-top:20px;
}
#status {
  margin-top:12px;
  color:#555;
}
</style>
</head>
<body>

<h1>Text to Speech Generator</h1>
<p>Enter text and click generate.</p>
<textarea id="prompt" placeholder="Type your text here..."></textarea><br>
<button id="gen">Generate</button>
<button id="dl" disabled>Download</button>
<div id="status">Ready.</div>
<audio id="player" controls></audio>

<script>
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let ctx, dest, recorder, chunks = [], blob;

const SONG_LENGTH = 150; // seconds
const BPM = 150;
const BEAT = 60 / BPM;

function midiToFreq(m){ return 440 * Math.pow(2,(m-69)/12); }

function status(t){ document.getElementById("status").innerText = t; }

function startRecording(){
  chunks = [];
  dest = ctx.createMediaStreamDestination();
  recorder = new MediaRecorder(dest.stream);
  recorder.ondataavailable = e => chunks.push(e.data);
  recorder.onstop = () => {
    blob = new Blob(chunks,{type:"audio/wav"});
    document.getElementById("dl").disabled = false;
    document.getElementById("player").src = URL.createObjectURL(blob);
  };
  recorder.start();
}

function stopRecording(){
  recorder.stop();
}

function square(freq,time,dur,vol=0.3){
  const o = ctx.createOscillator();
  o.type="square";
  o.frequency.value=freq;
  const g = ctx.createGain();
  g.gain.setValueAtTime(vol,time);
  g.gain.exponentialRampToValueAtTime(0.0001,time+dur);
  o.connect(g);
  g.connect(ctx.destination);
  g.connect(dest);
  o.start(time);
  o.stop(time+dur);
}

function noise(time,dur,vol=0.3){
  const buffer = ctx.createBuffer(1,ctx.sampleRate*dur,ctx.sampleRate);
  const data = buffer.getChannelData(0);
  for(let i=0;i<data.length;i++) data[i]=Math.random()*2-1;
  const src = ctx.createBufferSource();
  src.buffer = buffer;
  const g = ctx.createGain();
  g.gain.value = vol;
  src.connect(g);
  g.connect(ctx.destination);
  g.connect(dest);
  src.start(time);
}

function generateSong(){
  ctx = new AudioCtx();
  startRecording();
  status("Generating ZX Spectrum music...");

  let t = ctx.currentTime + 0.2;

  const key = 48 + Math.floor(Math.random()*8);
  const chords = [
    [0,4,7],
    [0,3,7],
    [2,5,9],
    [0,5,7]
  ];

  const leadScale = [0,2,3,5,7,8,10,12];

  const bars = Math.floor(SONG_LENGTH / (BEAT*4));

  for(let bar=0; bar<bars; bar++){
    const chord = chords[bar % chords.length];
    const root = key + (bar%2)*2;

    // Chord stabs
    for(let i=0;i<chord.length;i++){
      square(midiToFreq(root+chord[i]), t, BEAT*0.9, 0.12);
    }

    // Bass
    square(midiToFreq(root-12), t, BEAT*3.8, 0.25);

    // Arpeggio (ZX style fast)
    for(let i=0;i<16;i++){
      const note = root + chord[i%chord.length] + 12;
      square(midiToFreq(note), t + i*(BEAT/4), BEAT/4, 0.18);
    }

    // Lead melody
    if(bar%2===0){
      for(let i=0;i<4;i++){
        const n = root + leadScale[Math.floor(Math.random()*leadScale.length)] + 12;
        square(midiToFreq(n), t + i*BEAT, BEAT*0.9, 0.2);
      }
    }

    // Drums
    noise(t, 0.05, 0.4);
    noise(t + BEAT*2, 0.05, 0.35);

    t += BEAT*4;
  }

  setTimeout(()=>{
    stopRecording();
    status("Done.");
  }, SONG_LENGTH*1000 + 500);
}

document.getElementById("gen").onclick = generateSong;
document.getElementById("dl").onclick = () => {
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "zx_spectrum_track.wav";
  a.click();
};
</script>
</body>
</html>
