<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Text to Speech Generator</title>
<style>
body {
  background: #fff;
  color: #111;
  font-family: Arial, sans-serif;
  text-align: center;
  padding: 30px;
}
textarea {
  width: 80%;
  height: 100px;
  margin-top: 10px;
  font-size: 16px;
  padding: 10px;
}
button {
  font-size: 16px;
  padding: 12px 20px;
  margin: 10px;
  cursor: pointer;
}
#status { margin-top: 15px; color: #555; }
audio { width: 80%; margin-top: 20px; }
</style>
</head>
<body>

<h1>Text to Speech Generator</h1>
<p>Enter text below to influence the generated 8-bit theme:</p>
<textarea id="prompt" placeholder="Type something..."></textarea><br>
<button id="generate">Generate Music (Agent X Style)</button>
<button id="download" disabled>Download</button>
<div id="status">Ready.</div>
<audio id="player" controls></audio>

<script>
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let ctx, recorder, dest, chunks, finalBlob;

function setStatus(t){ document.getElementById("status").innerText = t; }

function hashSeed(str){
  let h=2166136261;
  for(let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = Math.imul(h,16777619);
  }
  return Math.abs(h);
}
function rng(seed){
  return function(){
    seed = (seed * 1664525 + 1013904223) >>> 0;
    return (seed & 0xffffffff) / 4294967296;
  };
}

function startRecord(){
  chunks = [];
  dest = ctx.createMediaStreamDestination();
  recorder = new MediaRecorder(dest.stream);
  recorder.ondataavailable = e => chunks.push(e.data);
  recorder.onstop = () => {
    finalBlob = new Blob(chunks, { type: "audio/wav" });
    document.getElementById("download").disabled = false;
    document.getElementById("player").src = URL.createObjectURL(finalBlob);
  };
  recorder.start();
}

function stopRecordAfter(sec){
  setTimeout(()=>recorder.stop(), sec*1000 + 500);
}

function square(freq, t, dur, vol=0.3){
  const osc = ctx.createOscillator();
  osc.type = 'square';
  osc.frequency.value = freq;
  const g = ctx.createGain();
  g.gain.setValueAtTime(vol, t);
  g.gain.exponentialRampToValueAtTime(0.0001, t + dur);
  osc.connect(g);
  g.connect(ctx.destination);
  g.connect(dest);
  osc.start(t);
  osc.stop(t + dur + 0.02);
}

function noiseBeat(t, dur=0.05, vol=0.25){
  const buffer = ctx.createBuffer(1, ctx.sampleRate*dur, ctx.sampleRate);
  const data = buffer.getChannelData(0);
  for(let i=0; i<data.length; i++) data[i] = Math.random()*2 - 1;
  const src = ctx.createBufferSource();
  src.buffer = buffer;
  const g = ctx.createGain();
  g.gain.value = vol;
  src.connect(g);
  g.connect(ctx.destination);
  g.connect(dest);
  src.start(t);
}

document.getElementById("generate").onclick = function(){
  ctx = new AudioCtx();
  setStatus("Generating 8-bit theme...");
  startRecord();

  const prompt = document.getElementById("prompt").value.trim() || "ZX Agent";
  const rand = rng(hashSeed(prompt));

  const BPM = 140 + Math.floor(rand()*40);
  const beat = 60 / BPM;
  const lengthBars = 64; // structure
  let t = ctx.currentTime + 0.2;
  const root = 48 + Math.floor(rand()*8);

  const scale = [0,2,3,5,7,8,10,12];

  function note(m){ return 440 * Math.pow(2,(m-69)/12); }

  // Intro arpeggio
  for(let i=0; i<16; i++){
    const n = root + scale[i % scale.length] + 24;
    square(note(n), t + i*(beat/2), beat/2, 0.22);
    if(rand()>0.7) noiseBeat(t + i*(beat/2), 0.04, 0.15);
  }
  t += beat*2;

  // Main theme + variations
  for(let bar=0; bar<lengthBars; bar++){
    const sectionRoot = root + ((bar%4)*2);

    // chord stab
    square(note(sectionRoot), t, beat, 0.25);
    square(note(sectionRoot+4), t, beat, 0.2);
    square(note(sectionRoot+7), t, beat, 0.18);

    // melody
    for(let m=0; m<4; m++){
      const idx = Math.floor(rand()*scale.length);
      const melNote = sectionRoot + scale[idx] + 12;
      square(note(melNote), t + m*beat, beat*0.9, 0.26);
      if(rand()>0.5) noiseBeat(t + m*beat, 0.04, 0.2);
    }

    // lead arpeggio fill
    if(bar % 8 < 4){
      for(let a=0; a<8; a++){
        const arpNote = sectionRoot + scale[a % scale.length] + 12;
        square(note(arpNote), t + a*(beat/8), beat/8, 0.17);
      }
    }

    // small vibe drum
    noiseBeat(t + beat*0.5, 0.03, 0.18);
    if(rand()>0.6) noiseBeat(t + beat*1.5, 0.03, 0.2);

    t += beat*2;
  }

  stopRecordAfter((lengthBars*2)*(beat) + 1);
};

document.getElementById("download").onclick = function(){
  const a = document.createElement("a");
  a.href = URL.createObjectURL(finalBlob);
  a.download = "agentx_style_theme.wav";
  a.click();
};

</script>
</body>
</html>
