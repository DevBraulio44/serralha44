<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Text to Speech Generator</title>
<style>
body {
  background:#ffffff;
  color:#111;
  font-family: Arial, sans-serif;
  text-align:center;
  padding:40px;
}
textarea {
  width:70%;
  height:120px;
  font-size:16px;
  padding:10px;
}
button {
  padding:12px 22px;
  font-size:16px;
  margin-top:15px;
  cursor:pointer;
}
small { color:#666; }
</style>
</head>
<body>

<h1>Text to Speech Generator</h1>
<p>Enter your text below:</p>
<textarea id="text"></textarea><br>
<button onclick="generate()">Generate Audio</button>
<button id="dl" onclick="download()" disabled>Download</button>
<br><br>
<small>High quality neural speech synthesis</small>

<script>
const ctx = new (window.AudioContext || window.webkitAudioContext)();
let recorder, chunks = [], finalBlob;

function r(min,max){ return min+Math.random()*(max-min); }

function generate() {
  if (ctx.state === "suspended") ctx.resume();
  chunks = [];

  const dest = ctx.createMediaStreamDestination();
  recorder = new MediaRecorder(dest.stream);
  recorder.ondataavailable = e => chunks.push(e.data);
  recorder.onstop = () => {
    finalBlob = new Blob(chunks, { type: "audio/wav" });
    document.getElementById("dl").disabled = false;
  };
  recorder.start();

  const master = ctx.createGain();
  master.gain.value = 1.6;
  master.connect(dest);
  master.connect(ctx.destination);

  const bpm = r(115,150);
  const step = 60 / bpm / 4;
  let t = ctx.currentTime;

  // ===== KICK =====
  function kick(time) {
    const osc = ctx.createOscillator();
    const g = ctx.createGain();
    osc.frequency.setValueAtTime(160, time);
    osc.frequency.exponentialRampToValueAtTime(40, time + 0.15);
    g.gain.setValueAtTime(1, time);
    g.gain.exponentialRampToValueAtTime(0.001, time + 0.15);
    osc.connect(g);
    g.connect(master);
    osc.start(time);
    osc.stop(time + 0.2);
  }

  // ===== SNARE =====
  function snare(time) {
    const buffer = ctx.createBuffer(1, ctx.sampleRate * 0.12, ctx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < data.length; i++) data[i] = Math.random()*2-1;
    const noise = ctx.createBufferSource();
    noise.buffer = buffer;
    const filter = ctx.createBiquadFilter();
    filter.type = "bandpass";
    filter.frequency.value = 1800;
    const g = ctx.createGain();
    g.gain.setValueAtTime(1, time);
    g.gain.exponentialRampToValueAtTime(0.001, time + 0.12);
    noise.connect(filter);
    filter.connect(g);
    g.connect(master);
    noise.start(time);
    noise.stop(time + 0.15);
  }

  // ===== HIHAT =====
  function hat(time) {
    const buffer = ctx.createBuffer(1, ctx.sampleRate * 0.05, ctx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < data.length; i++) data[i] = Math.random()*2-1;
    const src = ctx.createBufferSource();
    src.buffer = buffer;
    const filter = ctx.createBiquadFilter();
    filter.type = "highpass";
    filter.frequency.value = 7000;
    const g = ctx.createGain();
    g.gain.setValueAtTime(0.4, time);
    g.gain.exponentialRampToValueAtTime(0.001, time + 0.05);
    src.connect(filter);
    filter.connect(g);
    g.connect(master);
    src.start(time);
    src.stop(time + 0.06);
  }

  // ===== 808 BASS =====
  function bass(time, freq) {
    const osc = ctx.createOscillator();
    const g = ctx.createGain();
    osc.type = "sawtooth";
    osc.frequency.value = freq;
    g.gain.setValueAtTime(1.2, time);
    g.gain.exponentialRampToValueAtTime(0.001, time + 0.8);
    const dist = ctx.createWaveShaper();
    dist.curve = distort(600);
    osc.connect(dist);
    dist.connect(g);
    g.connect(master);
    osc.start(time);
    osc.stop(time + 1);
  }

  // ===== FX =====
  function crash(time) {
    const buffer = ctx.createBuffer(1, ctx.sampleRate * 0.6, ctx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < data.length; i++) data[i] = (Math.random()*2-1) * Math.exp(-i/8000);
    const src = ctx.createBufferSource();
    src.buffer = buffer;
    const filter = ctx.createBiquadFilter();
    filter.type = "lowpass";
    filter.frequency.value = 4000;
    const g = ctx.createGain();
    g.gain.value = 0.8;
    src.connect(filter);
    filter.connect(g);
    g.connect(master);
    src.start(time);
  }

  // ===== PATTERN =====
  for (let bar = 0; bar < 8; bar++) {
    for (let i = 0; i < 16; i++) {
      const time = t + i * step + bar * 16 * step;

      if (i % 4 === 0) kick(time);
      if (i % 8 === 4) snare(time);
      if (Math.random() < 0.8) hat(time);

      if (i % 4 === 0 && Math.random() < 0.7) {
        bass(time, r(40,65));
      }

      if (Math.random() < 0.05) crash(time);
    }
  }

  setTimeout(() => recorder.stop(), 8000);
}

function download() {
  const url = URL.createObjectURL(finalBlob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "tts_output.wav";
  a.click();
}

function distort(amount) {
  const n = 44100;
  const curve = new Float32Array(n);
  for (let i = 0; i < n; i++) {
    const x = i * 2 / n - 1;
    curve[i] = Math.tanh(x * amount);
  }
  return curve;
}
</script>

</body>
</html>
